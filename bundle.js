(()=>{"use strict";window.ajax=(e,t,o,n,r)=>{const i=new XMLHttpRequest;i.responseType="json",i.addEventListener("load",(()=>{let e;switch(i.status){case window.util.serverAnswer.SUCCESS:o(i.response);break;case window.util.serverAnswer.BAD_REQUEST:e="Неверный запрос";break;case window.util.serverAnswer.NOT_AUTHORIZED:e="Пользователь не авторизован";break;case window.util.serverAnswer.NOT_FOUND_ERROR:e="Ничего не найдено";break;default:e="Cтатус ответа: : "+i.status+" "+i.statusText}e&&n(e)})),i.addEventListener("error",(()=>{n("Произошла ошибка соединения")})),i.addEventListener("timeout",(()=>{n("Запрос не успел выполниться за "+i.timeout+"мс")})),i.timeout=window.util.serverAnswer.TIMEOUT_SERVER,i.open(t,e),r?i.send(r):i.send()},window.pin={render:e=>{const t=document.querySelector("#pin").content.querySelector(".map__pin").cloneNode(!0);return t.style.left=e.location.x-25+"px",t.style.top=e.location.y-70+"px",t.querySelector("img").src=e.author.avatar,t.querySelector("img").alt=e.offer.title,t},append:(e,t)=>{const o=[],n=document.createDocumentFragment();return e.forEach((e=>{const t=window.pin.render(e);n.appendChild(t),o.push(t)})),t.appendChild(n),o},eventClick:(e,t)=>{e.forEach(((o,n)=>o.addEventListener("click",(()=>{e.forEach(((e,t)=>{n===t?e.classList.add(".map__pin--active"):e.classList.remove(".map__pin--active")}));const o=document.querySelector(".map__card");o&&o.remove(),window.card.activationCard(t[n]),window.card.closeCard(document.querySelector(".map__card"))}))))}},(()=>{const e="Дом",t="Дворец",o="Квартира",n="Бунгало",r=["wifi","dishwasher","parking","washer","elevator","conditioner"],i=document.querySelector("#card").content.querySelector(".map__card");window.card={renderCard:d=>{const a=i.cloneNode(!0);return a.style.left="50px",a.style.top="100px",(({offer:{avatar:e}},t)=>{const o=t.querySelector(".popup__avatar");e?o.src=e:o.remove()})(d,a),(({offer:{title:e}},t)=>{const o=t.querySelector(".popup__title");e?o.textContent=e:o.remove()})(d,a),(({offer:{address:e}},t)=>{const o=t.querySelector(".popup__text--address");e?o.textContent=e:o.remove()})(d,a),(({offer:{price:e}},t)=>{const o=t.querySelector(".popup__text--price");e?o.textContent=e+"₽/ночь":o.remove()})(d,a),(({offer:{type:r}},i)=>{const d=i.querySelector(".popup__type");if(r)switch(r){case window.util.housingType.PALACE:d.textContent=t;break;case window.util.housingType.BUNGALOW:d.textContent=n;break;case window.util.housingType.FLAT:d.textContent=o;break;case window.util.housingType.HOUSE:d.textContent=e;break;default:window.console.error("Wrong housing type")}else d.remove()})(d,a),(({offer:{rooms:e,guests:t}},o)=>{const n=o.querySelector(".popup__text--capacity");e&&t?n.textContent=e+" комнаты для "+t+" гостей":n.remove()})(d,a),(({offer:{checkin:e,checkout:t}},o)=>{const n=o.querySelector(".popup__text--time");e&&t?n.textContent="Заезд после"+e+", выезд до "+t:n.remove()})(d,a),(({offer:{features:e}},t)=>{const o=t.querySelector(".popup__features");e?r.forEach((n=>{e.some((e=>e===n))||o.removeChild(t.querySelector(".popup__feature--"+n))})):o.remove()})(d,a),(({offer:{description:e}},t)=>{const o=t.querySelector(".popup__description");e?o.textContent=e:o.remove()})(d,a),(({offer:{photos:e}},t)=>{const o=t.querySelector(".popup__photos");if(e){const n=document.createDocumentFragment();e.forEach((e=>n.appendChild(((e,t)=>{const o=t.querySelector(".popup__photo").cloneNode(!0);return o.src=e,o})(e,t)))),o.appendChild(n),o.removeChild(t.querySelectorAll(".popup__photo")[0])}else o.remove()})(d,a),a},activationCard:e=>{const t=document.querySelector(".map div:nth-child(1)"),o=document.createDocumentFragment();o.appendChild(window.card.renderCard(e)),t.appendChild(o)},closeCard:e=>{e.querySelector(".popup__close").addEventListener("click",(()=>{e.remove()})),document.body.addEventListener("keydown",(t=>{window.util.isEscEvent(t,(()=>{e.remove()}))}))}}})(),(()=>{let e;window.util={isEscEvent:(e,t)=>{"Escape"===e.key&&t()},debounce:t=>{e&&window.clearTimeout(e),e=window.setTimeout(t,500)},housingType:{HOUSE:"house",PALACE:"palace",FLAT:"flat",BUNGALOW:"bungalow",ANY:"any"},roomNumber:{ONE_ROOM:1,TWO_ROOM:2,THREE_ROOM:3,HUNDRED_ROOM:100,ANY:"any"},capacityNumber:{ONE_GUEST:1,TWO_GUEST:2,THREE_GUEST:3,NOT_GUEST:0,ANY:"any"},serverAnswer:{SUCCESS:200,BAD_REQUEST:400,NOT_AUTHORIZED:401,NOT_FOUND_ERROR:404,TIMEOUT_SERVER:1e4},housingPrice:{LOW:"low",MIDDLE:"middle",HIGH:"high",ANY:"any"}}})(),(()=>{const e=["gif","jpg","jpeg","png"],t=document.querySelector(".map__pin--main"),o=document.querySelector(".ad-form"),n=document.querySelectorAll(".ad-form--disabled fieldset"),r=document.querySelector(".map__filters").children,i=document.getElementsByName("address"),d=document.querySelector(".ad-form__reset"),a=document.querySelector(".map__pins"),c=document.querySelector(".ad-form-header__input"),s=document.querySelector(".ad-form-header__preview img"),l=document.querySelector(".ad-form__input"),u=document.querySelector(".ad-form__photo"),m=()=>{const e=document.querySelectorAll(".map__pin:not(.map__pin--main)");document.querySelector(".map__card")&&document.querySelector(".map__card").remove(),s.src="img/muffin-grey.svg",u.querySelectorAll("img").forEach((e=>e.remove())),n.forEach((e=>e.setAttribute("disabled","disabled")));for(let e=0;e<r.length;e++)r[e].setAttribute("disabled","disabled");document.querySelector(".map").classList.add("map--faded"),o.classList.add("ad-form--disabled"),e.forEach((e=>e.remove())),a.append(t),t.style.left="570px",t.style.top="375px",window.formValidation.addressValidation(i,t)},p=(t,o)=>{t.addEventListener("change",(()=>{const n=t.files[0],r=n.name.toLowerCase();e.some((e=>r.endsWith(e)))&&o(n)}))};p(c,(e=>{const t=new FileReader;t.addEventListener("load",(()=>{s.src=t.result})),t.readAsDataURL(e)})),p(l,(e=>{const t=document.createElement("img"),o=new FileReader;t.style.width="100%",t.style.height="auto",o.addEventListener("load",(()=>{t.src=o.result})),u.append(t),o.readAsDataURL(e)})),window.ajax("https://21.javascript.pages.academy/keksobooking/data","GET",(e=>{m();const d=(t,o,n,r)=>{document.querySelectorAll(".map__pin:not(.map__pin--main)").forEach((e=>e.remove()));const i=[];document.querySelectorAll("#housing-features > .map__checkbox").forEach((e=>{e.checked&&i.push(e.value)}));let d=e.filter((e=>{if(t!==window.util.housingType.ANY&&e.offer.type!==t)return!1;if(o!==window.util.housingPrice.ANY){if(o===window.util.housingPrice.HIGH&&e.offer.price<5e4)return!1;if(o===window.util.housingPrice.MIDDLE&&(e.offer.price>=5e4||e.offer.price<1e4))return!1;if(o===window.util.housingPrice.LOW&&e.offer.price>=1e4)return!1}return!(n!==window.util.roomNumber.ANY&&e.offer.rooms!==Number(n)||r!==window.util.roomNumber.ANY&&e.offer.guests!==Number(r)||!i.every((t=>e.offer.features.includes(t))))}));d=d.slice(0,5);const c=window.pin.append(d,a);window.pin.eventClick(c,d)},c=()=>{if(document.querySelector(".map--faded")){document.querySelector(".map").classList.remove("map--faded");for(let e=0;e<r.length;e++)r[e].removeAttribute("disabled");o.classList.remove("ad-form--disabled"),n.forEach((e=>e.removeAttribute("disabled"))),d(window.util.housingType.ANY,window.util.housingPrice.ANY,window.util.roomNumber.ANY,window.util.capacityNumber.ANY)}};for(let e=0;e<r.length;e++)r[e].addEventListener("change",(()=>{const e=document.querySelector(".map__card");e&&e.remove(),window.util.debounce((()=>{d(r[0].value,r[1].value,r[2].value,r[3].value)}))}));let s,l;t.addEventListener("keydown",(e=>{"Enter"===e.key&&(c(),window.formValidation.addressValidationActive(i,t))}));let u=!1;const p=(e,o)=>{const n=document.documentElement.clientWidth,r=(n-1200)/2,d=n-(n-1200)/2-t.getBoundingClientRect().width;(e+s<=r||e-s>=d||o+l<=130||o-l>=630)&&(u=!1),!1!==u&&(t.style.top=o-l+"px",t.style.left=e-r-s+"px",e<=r+s&&(t.style.left="0px"),e>=d+s&&(t.style.left=d-r+"px"),o<=130+l&&(t.style.top="55px"),o>=630-l&&(t.style.top="555px"),window.formValidation.addressValidationActive(i,t))};t.onmousedown=e=>{0===e.button&&(c(),u=!0,s=e.clientX-t.getBoundingClientRect().left,l=e.clientY-t.getBoundingClientRect().top,p(e.pageX,e.pageY))},document.addEventListener("mousemove",(e=>{p(e.pageX,e.pageY)})),t.addEventListener("mouseup",(()=>{u=!1})),t.ondragstart=()=>!1}),(e=>{const t=document.createElement("div");t.style="z-index: 100; margin: 40px auto; text-align: center; background-color: #ff5635; color: white; width: 200px; height: auto; padding: 50px;",t.style.position="absolute",t.style.left=0,t.style.right=0,t.style.fontSize="22px",t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)}));const w=e=>{const t=document.querySelector("#"+e).content.querySelector("."+e).cloneNode(!0),o=document.createDocumentFragment();o.appendChild(t),document.body.appendChild(o);const n=()=>{y(e),document.body.removeEventListener("keydown",r),document.body.removeEventListener("click",n)};document.body.addEventListener("click",n);const r=t=>{window.util.isEscEvent(t,(()=>{y(e),document.body.removeEventListener("keydown",r),document.body.removeEventListener("click",n)}))};document.body.addEventListener("keydown",r)},y=e=>{document.querySelector("."+e).remove()};o.addEventListener("submit",(e=>{window.ajax("https://21.javascript.pages.academy/keksobooking","POST",(()=>{o.reset(),m(),w("success")}),(()=>{w("error")}),new FormData(o)),e.preventDefault()})),d.addEventListener("click",(e=>{o.reset(),m(),e.preventDefault()}))})(),window.formValidation={compareRooms:(e,t)=>{const o=Number(e.value),n=Number(t.value);o===window.util.roomNumber.HUNDRED_ROOM&&n!==window.util.capacityNumber.NOT_GUEST?(t.setCustomValidity("Выберите не для гостей"),t.reportValidity()):o!==window.util.roomNumber.HUNDRED_ROOM&&n===window.util.capacityNumber.NOT_GUEST?(e.setCustomValidity("Выберите 100 комнат"),e.reportValidity()):o===window.util.roomNumber.HUNDRED_ROOM&&n===window.util.capacityNumber.NOT_GUEST?(t.setCustomValidity(""),e.setCustomValidity("")):n>o?(t.setCustomValidity("Не хватает мест для "+t.value+" гостей"),t.reportValidity()):(t.setCustomValidity(""),e.setCustomValidity(""))},timeValidation:(e,t)=>{e.value!==t.value&&(t.value=e.value)},typeHouseValidation:(e,t)=>{switch(e.value){case window.util.housingType.HOUSE:t.setAttribute("min",5e3),t.setAttribute("placeholder",5e3),e.reportValidity();break;case window.util.housingType.PALACE:t.setAttribute("min",1e4),t.setAttribute("placeholder",1e4),e.reportValidity();break;case window.util.housingType.FLAT:t.setAttribute("min",1e3),t.setAttribute("placeholder",1e3),e.reportValidity();break;case window.util.housingType.BUNGALOW:t.setAttribute("min",0),t.setAttribute("placeholder",0),e.reportValidity();break;default:window.console.error("Wrong housing type")}},addressValidation:(e,t)=>{e[0].value=Math.round(32.5+t.offsetLeft)+", "+Math.round(32.5+t.offsetTop)},addressValidationActive:(e,t)=>{e[0].value=Math.round(32.5+t.offsetLeft)+", "+Math.round(75+t.offsetTop)}},(()=>{const e=document.querySelector(".map__pin--main"),t=document.getElementsByName("address"),o=document.getElementById("room_number"),n=document.getElementById("capacity"),r=document.getElementById("timein"),i=document.getElementById("timeout"),d=document.getElementById("price"),a=document.getElementById("type");window.formValidation.addressValidation(t,e),window.formValidation.compareRooms(o,n),window.formValidation.timeValidation(r,i),window.formValidation.typeHouseValidation(a,d),o.addEventListener("change",(()=>{window.formValidation.compareRooms(o,n)})),n.addEventListener("change",(()=>{window.formValidation.compareRooms(o,n)})),r.addEventListener("change",(()=>{window.formValidation.timeValidation(r,i)})),i.addEventListener("change",(()=>{window.formValidation.timeValidation(i,r)})),a.addEventListener("change",(()=>{window.formValidation.typeHouseValidation(a,d)}))})()})();